<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concrete Crushers - Game Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors; }
        .btn-secondary { @apply bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition-colors; }
        .card { @apply bg-white rounded-xl shadow-sm border border-gray-200 p-6; }
        .badge { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
        .badge-success { @apply bg-green-100 text-green-800; }
        .badge-warning { @apply bg-yellow-100 text-yellow-800; }
        .badge-danger { @apply bg-red-100 text-red-800; }
        .input { @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500; }
        .loading { @apply animate-pulse bg-gray-200 rounded; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">CC</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900">Concrete Crushers</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showPage('home')" class="btn-secondary" id="home-nav">Home</button>
                        <button onclick="showPage('roster')" class="btn-secondary" id="roster-nav">Roster</button>
                        <button onclick="showPage('schedule')" class="btn-secondary" id="schedule-nav">Schedule</button>
                        <button onclick="showPage('admin')" class="btn-secondary" id="admin-nav">Admin</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Home Page -->
        <div id="home-page" class="page max-w-6xl mx-auto">
            <!-- Fixed Header Section -->
            <div class="sticky top-0 bg-white z-10 p-4 space-y-4 border-b shadow-sm">
                <!-- Featured Game Info Card -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl p-6 shadow-lg">
                    <div id="game-info" class="loading h-20 bg-blue-500 rounded"></div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-green-600" id="attending-count">-</div>
                        <div class="text-sm text-gray-600">Attending</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-3xl font-bold text-red-600" id="not-attending-count">-</div>
                        <div class="text-sm text-gray-600">Not Attending</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-lg font-semibold" id="game-status">-</div>
                        <div class="text-sm text-gray-600">Game Status</div>
                    </div>
                </div>
            </div>

            <!-- Scrollable Roster Section -->
            <div class="p-4">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Quick Check-in</h2>
                    <div id="roster-checkin" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="loading h-6"></div>
                        <div class="loading h-6"></div>
                        <div class="loading h-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roster Page -->
        <div id="roster-page" class="page hidden max-w-6xl mx-auto p-4">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">Team Roster</h2>
                <div id="roster-list" class="space-y-3">
                    <div class="loading h-16"></div>
                    <div class="loading h-16"></div>
                    <div class="loading h-16"></div>
                </div>
            </div>
        </div>

        <!-- Schedule Page -->
        <div id="schedule-page" class="page hidden max-w-6xl mx-auto p-4">
            <div class="card">
                <h2 class="text-2xl font-bold mb-6">Summer Ball 2025 Schedule</h2>
                <div id="schedule-list" class="space-y-4">
                    <div class="loading h-20"></div>
                    <div class="loading h-20"></div>
                    <div class="loading h-20"></div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page hidden max-w-6xl mx-auto p-4">
            <!-- Password Screen -->
            <div id="admin-login" class="max-w-md mx-auto mt-20">
                <div class="card text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-blue-600 text-2xl">ðŸ”’</span>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Admin Access</h2>
                    <p class="text-gray-600 mb-6">Enter password to access admin controls</p>
                    <form onsubmit="adminLogin(event)" class="space-y-4">
                        <input type="password" id="admin-password" placeholder="Enter admin password" class="input" required>
                        <button type="submit" class="btn-primary w-full">Access Admin</button>
                        <button type="button" onclick="showPage('home')" class="btn-secondary w-full">Back to Home</button>
                    </form>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden space-y-6">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold">Admin Panel</h1>
                    <button onclick="adminLogout()" class="btn-secondary">Logout</button>
                </div>

                <!-- Admin Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card text-center">
                        <div class="text-2xl font-bold text-green-600" id="admin-attending">-</div>
                        <div class="text-sm text-gray-600">Attending</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-2xl font-bold text-red-600" id="admin-not-attending">-</div>
                        <div class="text-sm text-gray-600">Not Attending</div>
                    </div>
                    <div class="card text-center">
                        <div class="text-lg font-semibold" id="admin-status">-</div>
                        <div class="text-sm text-gray-600">Game Status</div>
                    </div>
                </div>

                <!-- Attendance Management -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Attendance Management</h2>
                        <button onclick="clearAllResponses()" class="btn-danger">Clear All Responses</button>
                    </div>
                    <div id="admin-attendees" class="space-y-2">
                        <div class="loading h-12"></div>
                    </div>
                </div>

                <!-- Game Management -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Game Management</h2>
                    <div id="admin-games" class="space-y-2">
                        <div class="loading h-12"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTeaQDeyElLcs9A1Iwdtq2V_yygbBv0_w",
            authDomain: "crushers-fdef6.firebaseapp.com",
            projectId: "crushers-fdef6", 
            storageBucket: "crushers-fdef6.firebasestorage.app",
            appId: "1:808539884493:web:50e78b199b61fbccc9d284"
        };

        // Global state
        let currentPage = 'home';
        let isAdminAuthenticated = false;
        let roster = [];
        let attendees = [];
        let games = [];
        let activeGame = null;
        let db = null;

        // Page navigation
        window.showPage = function(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
            document.getElementById(page + '-nav').classList.add('bg-blue-600', 'text-white');
            
            currentPage = page;
            loadPageData();
        };

        // Admin authentication
        window.adminLogin = function(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password.toLowerCase() === 'dixie') {
                isAdminAuthenticated = true;
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAdminData();
            } else {
                alert('Incorrect password. Please try again.');
                document.getElementById('admin-password').value = '';
            }
        };

        window.adminLogout = function() {
            isAdminAuthenticated = false;
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-password').value = '';
        };

        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization failed:', error);
            }
        }

        // Data loading functions
        async function loadRoster() {
            try {
                console.log('Loading roster from Firebase...');
                const snapshot = await db.collection('teamRoster').where('isActive', '==', true).get();
                roster = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`));
                console.log('Roster loaded:', roster.length, 'players');
                return roster;
            } catch (error) {
                console.error('Error loading roster:', error);
                // Fallback: show error message in UI
                document.getElementById('roster-checkin').innerHTML = 
                    '<p class="text-red-600">Error connecting to database. Please refresh the page.</p>';
                return [];
            }
        }

        async function loadAttendees() {
            try {
                console.log('Loading attendees from Firebase...');
                const snapshot = await db.collection('attendees').get();
                attendees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Attendees loaded:', attendees.length, 'responses');
                return attendees;
            } catch (error) {
                console.error('Error loading attendees:', error);
                return [];
            }
        }

        async function loadGames() {
            try {
                console.log('Loading games from Firebase...');
                const gamesSnapshot = await db.collection('games').orderBy('date').get();
                games = gamesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const activeSnapshot = await db.collection('games').where('isActive', '==', true).limit(1).get();
                if (!activeSnapshot.empty) {
                    activeGame = { id: activeSnapshot.docs[0].id, ...activeSnapshot.docs[0].data() };
                }
                
                console.log('Games loaded:', games.length, 'games, active game:', activeGame?.opponent);
                return games;
            } catch (error) {
                console.error('Error loading games:', error);
                return [];
            }
        }

        // Check-in functionality
        window.checkIn = async function(firstName, lastName, status) {
            try {
                // Optimistic update for instant UI response
                const existingAttendee = attendees.find(a => a.firstName === firstName && a.lastName === lastName);
                if (existingAttendee) {
                    existingAttendee.status = status;
                } else {
                    attendees.push({ firstName, lastName, status });
                }
                
                // Update UI immediately
                updateDisplay();
                
                // Then sync with Firebase
                const existingSnapshot = await db.collection('attendees')
                    .where('firstName', '==', firstName)
                    .where('lastName', '==', lastName)
                    .get();

                if (!existingSnapshot.empty) {
                    // Update existing attendee
                    const doc = existingSnapshot.docs[0];
                    await doc.ref.update({ status, updatedAt: new Date() });
                } else {
                    // Create new attendee
                    await db.collection('attendees').add({
                        firstName,
                        lastName,
                        status,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }
                
            } catch (error) {
                console.error('Error checking in:', error);
                // Reload data on error to ensure consistency
                await loadAttendees();
                updateDisplay();
                alert('Error updating attendance. Please try again.');
            }
        };

        // Admin functions
        window.clearAttendee = async function(attendeeId) {
            try {
                await db.collection('attendees').doc(attendeeId).delete();
                await loadAttendees();
                updateDisplay();
            } catch (error) {
                console.error('Error clearing attendee:', error);
                alert('Error clearing attendance. Please try again.');
            }
        };

        window.clearAllResponses = async function() {
            if (confirm('Are you sure you want to clear all responses?')) {
                try {
                    const snapshot = await db.collection('attendees').get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    await loadAttendees();
                    updateDisplay();
                } catch (error) {
                    console.error('Error clearing all responses:', error);
                    alert('Error clearing all responses. Please try again.');
                }
            }
        };

        window.setActiveGame = async function(gameId) {
            try {
                // First, set all games to inactive
                const allGamesSnapshot = await db.collection('games').get();
                const batch = db.batch();
                
                allGamesSnapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { isActive: false });
                });
                
                // Set the selected game to active
                batch.update(db.collection('games').doc(gameId), { isActive: true });
                
                await batch.commit();
                await loadGames();
                updateDisplay();
            } catch (error) {
                console.error('Error setting active game:', error);
                alert('Error setting active game. Please try again.');
            }
        };

        // Display functions
        function updateDisplay() {
            if (currentPage === 'home') {
                renderHome();
            } else if (currentPage === 'roster') {
                renderRoster();
            } else if (currentPage === 'schedule') {
                renderSchedule();
            } else if (currentPage === 'admin' && isAdminAuthenticated) {
                renderAdmin();
            }
        }

        function renderHome() {
            // Game info - prominent display
            if (activeGame) {
                document.getElementById('game-info').innerHTML = `
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-white mb-2">NEXT GAME</h1>
                        <div class="text-2xl font-semibold text-blue-100 mb-3">vs ${activeGame.opponent}</div>
                        <div class="flex justify-center items-center gap-6 text-blue-100">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">${formatDate(activeGame.date)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">${activeGame.time}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">${activeGame.location}</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${activeGame.homeAway === 'Home' ? 'bg-green-500' : 'bg-orange-500'} text-white">
                                ${activeGame.homeAway} Game
                            </span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('game-info').innerHTML = '<p class="text-center text-blue-100">No active game scheduled</p>';
            }

            // Stats
            const attending = attendees.filter(a => a.status === 'attending').length;
            const notAttending = attendees.filter(a => a.status === 'not_attending').length;
            const needed = Math.max(0, 10 - attending);
            const gameStatus = attending >= 10 ? 'Game confirmed!' : `${attending}/10 - ${needed} more needed!`;

            document.getElementById('attending-count').textContent = attending;
            document.getElementById('not-attending-count').textContent = notAttending;
            document.getElementById('game-status').textContent = gameStatus;

            // Roster check-in
            document.getElementById('roster-checkin').innerHTML = roster.map(member => {
                const attendee = attendees.find(a => a.firstName === member.firstName && a.lastName === member.lastName);
                const status = attendee?.status;
                
                return `
                <div class="flex items-center justify-between p-3 border rounded-lg ${status === 'attending' ? 'bg-green-50 border-green-200' : status === 'not_attending' ? 'bg-red-50 border-red-200' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="font-medium">${member.firstName} ${member.lastName}</span>
                        ${status ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${status === 'attending' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${status === 'attending' ? 'âœ“ Attending' : 'âœ— Not Attending'}
                        </span>` : '<span class="text-gray-500 text-sm">No response</span>'}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="checkIn('${member.firstName}', '${member.lastName}', 'attending')" 
                                class="btn-success ${status === 'attending' ? 'opacity-50' : ''}">In</button>
                        <button onclick="checkIn('${member.firstName}', '${member.lastName}', 'not_attending')" 
                                class="btn-danger ${status === 'not_attending' ? 'opacity-50' : ''}">Out</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderRoster() {
            document.getElementById('roster-list').innerHTML = roster.map(member => `
                <div class="flex items-center justify-between p-4 border rounded-lg">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="font-bold text-blue-600">${member.firstName[0]}${member.lastName[0]}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold">${member.firstName} ${member.lastName}</h3>
                            <p class="text-gray-600">${member.position} â€¢ #${member.jerseyNumber}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Games Played</div>
                        <div class="font-bold">${member.gamesPlayed || 0}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderSchedule() {
            document.getElementById('schedule-list').innerHTML = games.map(game => `
                <div class="border rounded-lg p-4 ${game.isActive ? 'border-blue-500 bg-blue-50' : ''}">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">vs ${game.opponent}</h3>
                            <p class="text-gray-600">${formatDate(game.date)} â€¢ ${game.time}</p>
                            <p class="text-gray-600">${game.location}</p>
                        </div>
                        <div class="text-right">
                            <span class="badge ${game.homeAway === 'Home' ? 'badge-success' : 'badge-warning'}">${game.homeAway}</span>
                            ${game.isActive ? '<div class="text-sm text-blue-600 font-medium mt-1">Active Game</div>' : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderAdmin() {
            // Admin stats
            const attending = attendees.filter(a => a.status === 'attending').length;
            const notAttending = attendees.filter(a => a.status === 'not_attending').length;
            const gameStatus = attending >= 10 ? 'Game confirmed' : 'Need more players';

            document.getElementById('admin-attending').textContent = attending;
            document.getElementById('admin-not-attending').textContent = notAttending;
            document.getElementById('admin-status').textContent = gameStatus;

            // Admin attendees
            document.getElementById('admin-attendees').innerHTML = attendees.length ?
                attendees.map(attendee => `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <div>
                            <span class="font-medium">${attendee.firstName} ${attendee.lastName}</span>
                            <span class="badge ml-2 ${attendee.status === 'attending' ? 'badge-success' : 'badge-danger'}">
                                ${attendee.status === 'attending' ? 'Attending' : 'Not Attending'}
                            </span>
                        </div>
                        <button onclick="clearAttendee('${attendee.id}')" class="btn-danger">Clear</button>
                    </div>
                `).join('') : '<p class="text-gray-600">No responses yet</p>';

            // Admin games
            document.getElementById('admin-games').innerHTML = games.map(game => `
                <div class="flex items-center justify-between p-3 border rounded-lg ${game.isActive ? 'border-blue-500 bg-blue-50' : ''}">
                    <div>
                        <span class="font-medium">vs ${game.opponent}</span>
                        <span class="text-gray-600 ml-2">${formatDate(game.date)}</span>
                    </div>
                    ${game.isActive ? 
                        '<span class="badge badge-success">Active</span>' : 
                        `<button onclick="setActiveGame('${game.id}')" class="btn-primary">Set Active</button>`
                    }
                </div>
            `).join('');
        }

        // Helper functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
        }

        async function loadPageData() {
            if (currentPage === 'home' || currentPage === 'admin') {
                await Promise.all([loadRoster(), loadAttendees(), loadGames()]);
            } else if (currentPage === 'roster') {
                await loadRoster();
            } else if (currentPage === 'schedule') {
                await loadGames();
            }
            updateDisplay();
        }

        async function loadAdminData() {
            await Promise.all([loadRoster(), loadAttendees(), loadGames()]);
            renderAdmin();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            initFirebase();
            await loadPageData();
            showPage('home');
        });
    </script>
</body>
</html>
